#!/bin/bash
# Assumes that the environment variable UNISON_DIR is set to the top of the
# Unison repo
MULTIBACKEND_DIR=$UNISON_DIR/src/solvers/multi_backend
MINIZINC_DIR=$MULTIBACKEND_DIR/minizinc
COMMON_DIR=$MULTIBACKEND_DIR/common
search='topdown.mzn'
allsolns='-a'
mzn='mzn-gecode'
cumulative='true'
diffn='true'
ncores='1'
statflag='-s'
toflag=''
toprefix='--fzn-flag --time-out --fzn-flag '
freeflag=''
freedefault='--fzn-flag -f'
rndflag=''
nogoods=''
setuponly='false'
while [ $# -gt  1 ]; do
    opt="$1"
    shift
    case "${opt}" in
      --bottomup | --bottom-up | --bottom_up)
        search='bottomup.mzn'
        allsolns=''
      ;;
      --topdown | --top-down | --top_down)
        search='topdown.mzn'
        allsolns='-a'
      ;;
      --gecode)
        mzn='mzn-gecode'
      ;;
      --sicstus)
        mzn='mzn-sicstus'
      ;;
      --g12cpx)
        mzn='mzn-g12cpx'
      ;;
      --cpx)
        mzn='mzn-cpx'
      ;;
      --chuffed | --chuffed21)
        mzn='mzn-chuffed --fzn-flag --mdd --fzn-flag on'
      ;;
      --chuffed20)
        mzn='mzn-chuffed'
        statflag='--fzn-flag -verbosity=3'
	toprefix='--fzn-flag -time_out='
      ;;
      --or-tools)
          mzn='mzn-or-tools'
	  freedefault='--fzn-flag --free_search'
	  toprefix='--fzn-flag -time_limit --fzn-flag '
      ;;
      --or-tools-sat)
          mzn='mzn-or-tools-sat'
	  statflag='--fzn-flag --fz_logging'
	  freedefault='--fzn-flag --free_search'
	  toprefix='--fzn-flag -time_limit --fzn-flag '
      ;;
      --cumulative)
        cumulative='true'
      ;;
      --no-cumulative)
        cumulative='false'
      ;;
      --diffn)
        diffn='true'
      ;;
      --no-diffn)
        diffn='false'
      ;;
      --free)
        freeflag=$freedefault
      ;;
      --rnd)
        rndflag='--fzn-flag --rnd-seed --fzn-flag 123456'
      ;;
      --vsids)
        freeflag='--fzn-flag -vsids=true'
      ;;
      --to)
	toflag=$toprefix$1
	shift
	;;
      --nogoods)
	  nogoods='--fzn-flag --learnt-stats-nogood'
      ;;
      -o)
	OUTJSON=$1
	shift
      ;;
      -p)
	ncores=$1
	shift
      ;;
      --setuponly)
	setuponly=true
      ;;
    esac
done
DIRBASENAME=${1%.ext.json}
EXTJSON=$1
shift
echo "json2dzn('${EXTJSON}')." | sicstus -f --nologo --noinfo -l $MINIZINC_DIR/model2dzn.pl
# for first solution:
# cat $MINIZINC_DIR/code-generation.mzn $MINIZINC_DIR/${search} | sed 's/minimize(obj)/satisfy/' > code-generation.mzn
cat $MINIZINC_DIR/code-generation.mzn $MINIZINC_DIR/${search} > $DIRBASENAME.mzn
if [ '$mzn' = 'mzn-gecode' ]; then
  pflag='-p'
  pvalue=${ncores}
else
  pflag=''
  pvalue=''
fi
if [ $setuponly = true ]; then
    exit 0
fi
set -x
time ${mzn} ${allsolns} -k ${statflag} ${pflag} ${pvalue} ${freeflag} ${rndflag} ${toflag} ${nogoods} -D good_cumulative=${cumulative} -D good_diffn=${diffn} $DIRBASENAME.mzn $DIRBASENAME.dzn | $COMMON_DIR/outfilter.pl ${OUTJSON}.last > ${OUTJSON}
